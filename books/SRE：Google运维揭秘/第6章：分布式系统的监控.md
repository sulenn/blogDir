[toc]

# 分布式系统的监控

## 术语定义

- **监控（monitoring）**：收集、处理、汇总，并且显示关于某个系统的实时量化数据，例如请求的数量和类型，错误的数量和类型
- **白盒监控（white-box monitoring）**：依靠系统内部暴露的一些性能指标进行监控。如日志分析
- **黑盒监控（black-box monitoring）**：通过测试某种外部用户可见的系统行为进行监控
- **监控台页面（dashboard）**：提供某个服务核心指标一览服务的应用程序（一般是基于Web的）。该应用程序可能会提供过滤功能（filter）、选择功能（selector）等
- **警报（alert）**：目标对象是某个人发向某个系统地址的一个通知。目的地可以包括工单系统、E-mail地址，或者某个传呼机。
- **根源问题（root cause）**：指系统（软件或流程）中的某种缺陷。这个缺陷如果被修复，就可以保证这种问题不会再以同样的方式发生。
- **节点或者机器（node/machine）**：这里的两个术语是可以互换的：指在物理机、虚拟机，或者容器内运行的某个实例
- **推送（push）**：关于某个服务正在运行的软件或者其配置文件的任何改动

## 为什么要监控

监控与报警可以让一个系统在发生故障时主动通知我们，或者能够告诉我们即将发生什么



- **分析长期趋势**：数据库目前的数据量，以及增长速度。又例如每日活跃用户的数量增长的速度。
- **跨时间范围的比较，或者是观察实验组与控制组之间的区别**：增加新节点后，memcache的缓存命中率是否增加？网站是否比上周速度要慢？
- **构建监控台页面**：
- **临时性的回溯分析（也就是在线调试）**：我们的请求延迟刚刚大幅增加了，有没有其他的现象同时发生？



紧急警报的处理会占用员工的宝贵时间。当紧急警报出现得太频繁时，员工会进入“狼来了”效应，怀疑警报的有效性甚至忽略该警报，有的时候在警告过多的时候甚至会忽略掉真实发生的故障。由于无效信息太多，分析和修复可能会变慢，故障时间也会相应延长。高效的警报系统应该提供足够的信息，并且误报率非常低。

## 对监控系统设置合理预期

监控一个复杂的应用程序本身就是一项复杂的工程项目。



监控系统中最重要的一点就是整个“生产故障，人工处理紧急警报，简单定位和深入调试”过程必须要保持非常简单，必须能被团队中任何一个人所理解。



监控系统信噪比应该很高，发出紧急警报的组件需要非常简单而且可靠。产生警报的监控系统规则应该非常容易理解，同时代表一个清晰的故障场景。

## 现象和原因

监控系统应该解决两个问题：什么东西出故障了，以及为什么出故障。



“什么东西出故障了”即为现象（symptom）:“为什么”则代表了原因



“现象”和“原因”的区分是构建信噪比高的监控系统时最重要的概念

## 黑盒监控与白盒监控

黑盒监控与白盒监控最简单的区别是：黑盒监控是面向现象的，代表了目前正在发生的，而非预测会发生的问题，即“系统现在有故障”。



白盒监控则大量依赖对系统内部信息的检测，如系统日志、抓取提供指标信息的HTTP节点等。白盒监控系统因此可以检测到即将发生的问题及那些重试所掩盖的

## 4个黄金指标

**延迟、流量、错误和饱和度（saturation）**



- **延迟**：服务处理某个请求所需要的时间
- **流量**：系统中的某个高层次的指标针对系统负载需求所进行的度量。对Web服务器来说，该指标通常是每秒HTTP请求数量，同时可能按请求类型分类（静态请求与动态请求）
- **错误**：请求失败的速率，要么是显式失败（例如HTTP 500），要么是隐式失败（例如HTTP 200 回复中包含了错误内容），或者是策略原因导致的失败（例如，如果要求回复在1s内发出，任何超过1s的请求就都是失败请求）
- **饱和度**：服务容量有多“满”。通常是系统中目前最为受限的某种资源的某个具体指标的度量。（在内存受限的系统中，即为内存；在I/O受限的系统中，即为I/O）。这里要注意，很多系统在达到100% 利用率之前性能会严重下降，增加一个利用率目标也是很重要的。

## 关于长尾问题

区分平均值的“慢”和长尾值的“慢”的一个最简单办法是将请求按延迟分组计数（可以用来制作直方图）：延迟为0～10ms之间的请求数量有多少，30～100ms之间，100～300ms之间等。

## 度量指标时采用合适的精度

系统的不同部分应该以不同的精度进行度量，例如：



-  观察1分钟内的CPU平均负载可能会错失导致长尾延迟过高的某种较长时间的CPU峰值现象。
- 对于一个每年停机时间小于9小时的Web服务来说（年度可用率99.9%），每分钟检测1次或2次的监控频率可能过于频繁。

## 简化，直到不能再简化

复杂是没有止境的。设计监控系统时一定要追求简化。