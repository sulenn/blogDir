[TOC]

---

####任务描述

本关任务：根据下面的相关知识，完成与交易数据存储有关的选择题。

####相关知识

######账本数据介绍

分类账本中保存着所有交易变化的记录，具有有序和防篡改的特点。每一次交易链码需要将数据变化记录在分布式账本中，需要记录的数据称为状态，以键值对（`Key-Value`）的形式进行存储。

`Hyperledger Fabric`账本由两个不同但相关部分组成：

- 世界状态（`World State`）；

- 区块链（`Blockchain`）。

正如下图所示，分别使用 3 个部分表示了区块链账本数据的组成结构及其对应关系：

<br>

![image.png](https://ww1.sinaimg.cn/large/006alGmrgy1gcg0as1uo9j314g0g9q62.jpg)

<br>

- `L` 代表账本：账本包含区块链与世界状态；

- `B` 代表区块链：由多个区块组成的链；

- `W` 代表世界状态：数据的最新值。

**世界状态**在 `Hyperledger Fabric` 中是一个比较重要的概念，是以键值对的方式保存一组分类账本数据状态的最新值。保存世界状态的实际上是一个 `NoSQL` 数据库，以方便对状态的存储及检索；可以使应用程序无须遍历整个事务日志而快速获取当前账本的最新值。其 `Value` 可以是一个简单的值，也可以是一组由键值对组成的复杂数据结构。如下图所示：

<br>

![image.png](https://ww1.sinaimg.cn/large/006alGmrgy1gcg0fxgs3xj314s0drjvm.jpg)

<br>

从图中可以看到，每一个世界状态都具有一个版本号，起始版本号（`Version`）的值为 0。每次对状态进行更改时，状态的版本号都会递增。对状态进行更新时也会检查，确保它与创建事务时的版本匹配。

**区块链**是一个记录交易日志的文件系统，它是由哈希值链接的 `N` 个区块构造而成；每个区块包含一系列的多个有序的交易。区块头中包含了本区块所记录交易的哈希值，以及前一个区块头的哈希值。通过这种方式，分类账本中的所有交易都被有序的并以加密的形式链接一起。换言之，在分布式网络中，如果不破坏哈希链的话，根本无法篡改账本数据。

<br>

![image.png](https://ww1.sinaimg.cn/large/006alGmrgy1gcg0imrs3ij314p0j2dk5.jpg)

<br>

正如上面的区块链结构图所示，我们可以看到区块 `B2` 具有区块数据 `D2`，其包含的事务为：`T5`，`T6`，`T7`。最重要的是，区块 `B2` 的区块头（`H2`）中其包含 `D2` 中所有事务的加密散列以及来自上一区块（`B1`）的等效散列。通过这种链接方式，使得区块之间彼此有着不可分割的联系。

下面继续分析区块及交易所包含的详细结构。

**区块**：每一个区块都由三部分组成。

如下图所示，区块 `B2` 的区块头（`H2`）由区块编号（2）、当前块数据（`D2`）的哈希（`CH2`）和来自上一个区块（`块号1`）的哈希（`PH1`）的副本组成。

<br>

![image.png](https://ww1.sinaimg.cn/large/006alGmrgy1gcg103zdatj30td0dt40o.jpg)

<br>

1. `区块头`（`Block Header`）：区块头包含 3 个字段，在创建区块时写入；

    - `区块编号`（`Block number`）：从 0 开始的整数，对于追加到区块链的每个新的区块都会在前一个值的基础之上递增 1；

    - `当前区块哈希值`（`Current Block Hash`）：当前块中包含的所有事务的哈希值；

    - `上一个区块哈希`（`Previous Block Hash`）：区块链中上一个区块的哈希副本。

2. `区块数据`（`Block Data`）：在创建块时写入，包含按顺序排列的一系列交易；

3. `区块元数据`（`Block Metadata`）：此部分包含写入区块的时间，以及相应的证书，公钥和签名。随后，`Block Committer` 还为每个交易添加了一个有效 / 无效的指示符（也称之为位掩码）。

现在我们了解了区块中的结构，下面我们进一步来了解交易 / 事务的详细结构。

**交易**：区块中的区块数据（`Block Data`）包含了一系列的交易的详细结构，该交易记录了世界状态的变化。其结构如下所示：

<br>

![image.png](https://ww1.sinaimg.cn/large/006alGmrgy1gcg0zamxihj319g0v6jyl.jpg)

<br>

正如上面的交易结构图所示，区块 `B1` 的区块数据（`D1`）中的事务（`T4`）包括事务头（`H4`），事务签名（`S4`），事务提案（`P4`），事务响应（`R4`）和背书列表（`E4`）。

- `事务头`（`Header`）：获取有关事务的一些基本元数据，如链码相关的名称及其版本；

- `事务签名`（`Signature`）：该部分包含使用客户端应用程序私钥而创建的加密签名。用于检查事务内容是否被篡改；

- `事务提案`（`Proposal`）：包含要调用的链码的函数名称、调用函数所需的输入参数，链码根据提交的事务提案对分类账本进行更新；

- `事务响应`（`Response`）：调用链码模拟执行后获取到世界状态的前后值，作为读写集（`Read-Write Set）返回给客户端；

- `背书列表`（`Endorsement`）交易中只包含一个交易响应，但有多个来自所需组织的背书签名，以满足所需的背书策略。

######账本数据存储

区块链是以文件的形式进行存储的，各区块文件默认以 `blockfile_` 为文件前缀，后面以 6 位数字命名，起始数字默认为 000000，如有新文件则每次递增1。区块链文件默认存储目录为 `/var/hyperledger/production/ledgersData/chains`，该目录中包括两个子目录：保存区块链文件的 `chains` 目录（以通道文件目录区分各 `Ledger`，各个 `Peer` 节点对于它所属的每个通道，都会保存一份该通道的账本副本）与使用 `LevelDB` 实现保存索引信息的 `index` 目录。目录结构如下：

```shell
root@a37b2b8a2858:/var/hyperledger/production/ledgersData/chains# ll
chains
|----mychannel
|----|----blockfile_000000
index
|----000001.log
|----CURRENT
|----LOCK
|----LOG
|----MANIFEST-000000
```

`Orderer` 节点本身保存一份账本，但不包括状态数据库及历史索引数据，这些都是由 `Peer` 节点进行维护。

在 `Peer` 节点中，除了存储一份账本之外，还需要维护状态数据库、历史数据库、区块索引这些内容，如下图所示：

<br>

![image.png](https://ww1.sinaimg.cn/large/006alGmrgy1gcg1d6gpftj31570tgn4m.jpg)

<br>

- `状态数据库`（`State Database`）：存储了交易日志中所有 `Key` 的最新值（`World State`），默认数据库使用 `LevelDB`。链码调用基于当前的状态数据执行交易。

- `历史数据库`（`History Database`）：以 `LevelDB` 数据库作为数据存储载体，存储区块中有效交易相关的 `Key`，而不存储 `Value`（数据库不允许 `Value` 为空，所以实际上 `Value` 都为 `[]byte{}`）。

- `idStore`：存储 `Peer` 加入的所有的 `ledgerId`（或称为为 `chainid/channelId`）。且保证账本编号在全局中的唯一性。默认存储目录为 `/var/hyperledger/production/ledgersData/ledgerProvider`。


####编程要求

根据相关知识，按照要求完成右侧选择题任务，包含单选题和多选题。

---
开始你的任务吧，祝你成功！