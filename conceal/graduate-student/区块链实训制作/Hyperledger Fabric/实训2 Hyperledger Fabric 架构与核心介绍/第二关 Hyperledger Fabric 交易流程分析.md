[TOC]

---

####任务描述

本关任务：根据本实训的相关知识，完成与 Hyperledger Fabric 交易流程分析相关的选择题。

####相关知识

本关讲解在一个标准的资产交换中的交易机制。该场景包含两个客户端 A 和 B，他们分别代表萝卜的买方和卖方。他们在网络上都有一个 Peer 节点，他们通过该节点来发送交易和与账本交互。

![image.png](https://ww1.sinaimg.cn/large/006alGmrgy1gbrinyn0byj30ji03ujrh.jpg)

#####前提

该流程中，假设已经设置了一个通道，并且该通道正常运行。应用程序的用户已经使用组织的 CA 注册和登记完成，并且拿到了用于在网络中用确认身份的加密材料。

链码（包含了萝卜商店初始状态的键值对）已经在 Peer 节点上安装并在通道上完成了实例化。链码中的逻辑定义了萝卜的交易和定价规则。链码也设置了一个背书策略，该策略是每一笔交易都必须被 `peerA` 和 `peerB` 都签名。

![image.png](https://ww1.sinaimg.cn/large/006alGmrgy1gbrirtlkuyj30l008swf5.jpg)

#####1. 客户端 A 启动一笔交易

客户端 A 发送一个采购萝卜的请求。该请求会到达 `peerA` 和 `peerB`，他们分别代表客户端 A 和客户端 B。背书策略要求所有交易都要两个节点背书，因此请求要经过 `peerA` 和 `peerB`。

然后，要构建一个交易提案。应用程序使用所支持的 SDK（Node，Java，Python）中的 API 生成一个交易提案。提案是带有确定输入参数的调用链码方法的请求，该请求的作用可能是读取或者更新账本。

SDK 的作用是将交易提案打包成合适的格式（gRPC 使用的 protocol buffer）以及根据用户的密钥对交易提案生成签名。

![image.png](https://ww1.sinaimg.cn/large/006alGmrgy1gbriuyzm2bj30nq094q3v.jpg)

#####2. 背书节点验证签名并执行交易

背书节点验证（1）交易提案的格式完整，（2）验证该交易提案之前没有被提交过（重放攻击保护），（3）验证签名是有效的（使用MSP），（4）验证发起者（在这个例子中是客户端A）是已经被授权在该通道上执行该操作（也就是说，每个背书节点确保发起者满足通道 Writers 策略）。背书节点将交易提案输入作为调用的链码函数的参数。然后针对当前状态数据库执行链码，生成交易结果，包括响应值、读集和写集（即表示要创建或更新的资产的键值对）。目前没有对账本进行更新。这些值，以及背书节点的签名，一起作为“提案响应”传递回SDK，SDK为应用程序解析出来这些数据再使用。

![image.png](https://ww1.sinaimg.cn/large/006alGmrgy1gbrixg6lk3j30ab06maa9.jpg)

#####3. 检查提案响应

应用程序验证背书节点的签名，并比较多个提案响应，以确定提案响应是否相同。如果链码只查询账本，应用程序将检查查询响应，并且通常不会将交易提交给排序服务。如果客户端应用程序打算向排序服务提交交易以更新账本，则应用程序在提交之前需确定是否已满足指定的背书策略（即 peerA 和 peerB 都要背书）。该体系结构是这样的，即使应用程序选择不检查响应或以其他方式转发未背书的交易，背书策略仍将由节点强制执行，并在提交验证阶段遵守该策略。

![image.png](https://ww1.sinaimg.cn/large/006alGmrgy1gbriz4g3jqj30nl06igmg.jpg)

#####4. 客户端将背书结果封装进交易

应用程序将交易提案和“交易消息”中的交易响应“广播”给排序服务。交易会包含读/写集，背书节点的签名和通道ID。排序服务不需要为了执行其操作而检查交易的整个内容，它只是从网络中的所有通道接收交易，将它们按时间按通道排序，并将每个通道的交易打包成区块。

![image.png](https://ww1.sinaimg.cn/large/006alGmrgy1gbrj09xs48j30nh06vjrx.jpg)

#####5. 验证和提交交易

交易区块被“发送”给通道上的所有 Peer 节点。对区块内的交易进行验证，以确保满足背书策略，并确保自交易执行生成读集以来，没有对读集变量的账本状态进行更改。块中的交易会被标记为有效或无效。

![image.png](https://ww1.sinaimg.cn/large/006alGmrgy1gbrj1dtavij30gn072dg4.jpg)

######6. 账本更新

每个 Peer 节点都将区块追加到通道的链上，对于每个有效的交易，写入集都提交到当前状态数据库。系统会发出一个事件，通知客户端应用程序本次交易（调用）已被不可更改地附加到链上，同时还会通知交易验证结果是有效还是无效。

####编程要求

根据相关知识，按照要求完成右侧选择题任务，其中第一题为多选题，第二、三题为单选题。

---
开始你的任务吧，祝你成功！